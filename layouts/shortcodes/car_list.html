{{ $t_brand := .Get "brand" }}
{{ $t_v_brand := .Get "v_brand" }}
{{ $file := resources.Get "data/64_collection.csv" }}

{{ if $file }}
  {{ $csv := $file | transform.Unmarshal }}
  {{ $data := slice }}

  {{/* PART 1: 過濾資料並存入 slice (加入 trim 確保資料乾淨) */}}
  {{ range $index, $row := $csv }}
    {{ if ne $index 0 }}
      {{/* 把抓出來的資料先刪掉頭尾空格 */}}
      {{ $row_brand   := trim (index $row 1) " " }}
      {{ $row_v_brand := trim (index $row 4) " " }}
      {{ $row_type    := trim (index $row 5) " " }} {{/* 假設 type 在第 6 欄 */}}
      
      {{ $match := false }}
      {{ if $t_brand }}
        {{ if eq $row_brand $t_brand }}{{ $match = true }}{{ end }}
      {{ else if $t_v_brand }}
        {{ if eq $row_v_brand $t_v_brand }}{{ $match = true }}{{ end }}
      {{ end }}

      {{ if $match }}
        {{ $item := dict 
          "brand"   $row_brand
          "id"      (index $row 2)
          "img"     (index $row 3)
          "v_brand" $row_v_brand
          "type"    $row_type
          "name"    (index $row 6)
        }}
        {{ $data = $data | append $item }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* PART 2: 排序邏輯 */}}
  {{ $sortedData := $data }}
  
  {{ if $t_brand }}
    {{/* 品牌頁：先按車名(name)排，再按車商(v_brand)歸類 */}}
    {{/* 這樣同一牌的 BMW 會排在一起，同一牌的 Honda 會排在一起 */}}
    {{ $sortedData = sort (sort $data "type" "asc") "v_brand" "asc" }}
  {{ else if $t_v_brand }}
    {{/* 車商頁：先按車型(name)排，再按模型品牌(brand)歸類 */}}
    {{/* 這樣同個模型牌子裡的 M3, M4 會按字母順序排好 */}}
    {{ $sortedData = sort (sort $data "id" "asc") "type" "asc" }}
  {{ end }}

  {{/* PART 3: 渲染 HTML */}}
  <div class="car-grid">
    {{ range $sortedData }}
    <div class="car-card">
      <div class="car-image-container" onclick="openLightbox('/images/cars/{{ .img }}', '{{ .name }}')">
        {{ if .img }}
          <img src="/images/cars/{{ .img }}" alt="{{ .name }}" loading="lazy">
        {{ else }}
          <div class="no-image">No Image</div>
        {{ end }}
      </div>
      <div class="car-info">
        <span class="car-id">{{ .brand }} #{{ .id }}</span>
        <p class="car-v-brand">{{ .v_brand }}</p>
        <p class="car-name">{{ .name }}</p>
      </div>
    </div>
    {{ end }}
  </div>

  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="close-btn">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
    <div id="caption"></div>
  </div>

{{ end }}

<script>
function openLightbox(src, title) {
  const lb = document.getElementById('lightbox');
  lb.style.display = "flex";
  document.getElementById('lightbox-img').src = src;
  document.getElementById('caption').innerHTML = title;
  document.body.style.overflow = "hidden"; // 點開時鎖定網頁捲軸
}

function closeLightbox() {
  const lb = document.getElementById('lightbox');
  lb.style.display = "none";
  document.body.style.overflow = "auto"; // 關閉時還原捲軸
}
</script>

<style>
  /* 1. 基礎網格與卡片 */
  .car-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; }
  .car-card { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow: hidden; transition: 0.2s; }
  .car-image-container { width: 100%; aspect-ratio: 4 / 3; background: #fdfdfd; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 5px; cursor: pointer; }
  .car-image-container img { width: 100%; height: 100%; object-fit: contain; }
  .car-info { padding: 8px; border-top: 1px solid #eee; }
  .car-id { font-size: 0.7rem; color: #cc0000; font-weight: bold; }
  .car-v-brand { font-size: 0.75rem; color: #666; margin: 2px 0; }
  .car-name { font-size: 0.85rem; font-weight: bold; margin: 0; line-height: 1.2; color: #333; }

  /* 2. 燈箱黑色背景：必須是全螢幕置中 */
  .lightbox {
    display: none; /* 由 JS 切換 */
    position: fixed;
    z-index: 10000;
    top: 0;
    left: 0;
    width: 100%;  /* 填滿寬度 */
    height: 100%; /* 填滿高度 */
    background-color: rgba(0,0,0,0.9);
    align-items: center;     /* 垂直置中 */
    justify-content: center;  /* 水平置中 */
    flex-direction: column;
    backdrop-filter: blur(5px); /* 背景模糊 */
  }

  /* 3. 燈箱內的圖片：這才是限制尺寸的地方 */
  .lightbox-content {
    max-width: 90vw;   /* 寬度最大 90% 視窗 */
    max-height: 80vh;  /* 高度最大 80% 視窗，留空間給文字 */
    object-fit: contain;
    box-shadow: 0 0 30px rgba(255,255,255,0.2); /* 讓圖片發光 */
    border: 2px solid rgba(255,255,255,0.5); /* 淡淡的細邊框 */
    border-radius: 4px;
    transition: transform 0.3s ease;
  }

  /* 4. 關閉按鈕與文字 */
  #caption {
    margin-top: 15px;
    color: #fff;
    font-weight: bold;
    font-size: 1.1rem;
    text-shadow: 2px 2px 4px #000;
  }

  .close-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    color: #fff;
    font-size: 50px;
    cursor: pointer;
    line-height: 1;
    transition: 0.2s;
  }
  .close-btn:hover { color: #cc0000; }
</style>