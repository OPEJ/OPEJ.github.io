{{/* 1/64 專用 - 參考 N 規邏輯的穩定版 */}}
{{ $t_brand := .Get "brand" }}
{{ $t_v_brand := .Get "v_brand" }}
{{ $file := resources.Get "data/64_collection.csv" }}

{{ if $file }}
  {{ $csv := $file | transform.Unmarshal }}
  {{ $data := slice }}

  {{ range $index, $row := $csv }}
    {{ if gt $index 0 }}
      {{/* 1. 檢查欄位數量是否足夠 (0-7 共 8 欄) */}}
      {{ if gt (len $row) 12 }}
        
        {{/* 2. 抓取顯示狀態並徹底除錯 (空格、換行) */}}
        {{ $row_show := trim (index $row 12) " \n\r\t" }}

        {{/* 3. 第一道大門：只有填 1 才准進入，填 0 或不填直接被擋掉 */}}
        {{ if eq $row_show "1" }}
          
          {{/* 4. 進入第二道門：品牌與車商過濾 */}}
          {{ $brand   := trim (index $row 1) " \n\r\t" }}
          {{ $v_brand := trim (index $row 4) " \n\r\t" }}
          {{ $type    := trim (index $row 5) " \n\r\t" }}
          {{ $name    := index $row 6 }}
        
        {{/* 仿照 N 規的 or not 邏輯：沒傳參數就等於全部匹配 */}}
        {{ $matchB  := or (not $t_brand) (eq $brand $t_brand) }}
        {{ $matchVB := or (not $t_v_brand) (eq $v_brand $t_v_brand) }}

        {{/* 只有當「品牌」或「車商」其中一個匹配時才加入 (或是都沒傳時) */}}
        {{ if and $matchB $matchVB }}
          {{/* 在這裡的 dict 多加入 "rank" (index $row 13) */}}
          {{ $item := dict "brand" $brand "id" (index $row 2) "img" (index $row 3) "v_brand" $v_brand "type" $type "name" (index $row 6) "rank" (index $row 13) }}
          {{ $data = $data | append $item }}
        {{ end }}
      {{ end }}{{/* end if show == "1" */}}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* PART 2: 排序邏輯 */}}
  {{ $sortedData := $data }}
  
  {{ if $t_brand }}
    {{/* 品牌頁：先按車名(name)排，再按車商(v_brand)歸類 */}}
    {{/* 這樣同一牌的 BMW 會排在一起，同一牌的 Honda 會排在一起 */}}
    {{ $sortedData = sort (sort $data "type" "asc") "v_brand" "asc" }}
  {{ else if $t_v_brand }}
    {{/* 車商頁：先按車型(name)排，再按模型品牌(brand)歸類 */}}
    {{/* 這樣同個模型牌子裡的 M3, M4 會按字母順序排好 */}}
    {{ $sortedData = sort (sort $data "id" "asc") "type" "asc" }}
  {{ end }}

  {{/* PART 3: 渲染 HTML */}}
  <div class="car-grid">
    {{ range $sortedData }}
      {{/* 根據 .rank 加上不同的 class，這裡要合併在一起 */}}
      <div class="car-card {{ if eq .rank "3" }}rank-gold{{ else if eq .rank "2" }}rank-silver{{ end }}">
        <div class="car-image-container" onclick="openLightbox('/images/cars/{{ .img }}', '{{ .name }}')">
          {{ if .img }}
            <img src="/images/cars/{{ .img }}" alt="{{ .name }}" loading="lazy">
          {{ else }}
            <div class="no-image">No Image</div>
          {{ end }}
        </div>
        <div class="car-info">
          <span class="car-id">{{ .brand }} #{{ .id }}</span>
          <p class="car-v-brand">{{ .v_brand }}</p>
          <p class="car-name">{{ .name }}</p>
        </div>
      </div>
    {{ end }}
  </div>

  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="close-btn">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
    <div id="caption"></div>
  </div>

{{ end }}

<script>
function openLightbox(src, title) {
  const lb = document.getElementById('lightbox');
  lb.style.display = "flex";
  document.getElementById('lightbox-img').src = src;
  document.getElementById('caption').innerHTML = title;
  document.body.style.overflow = "hidden"; // 點開時鎖定網頁捲軸
}

function closeLightbox() {
  const lb = document.getElementById('lightbox');
  lb.style.display = "none";
  document.body.style.overflow = "auto"; // 關閉時還原捲軸
}
</script>

<style>
  /* 1. 基礎網格與卡片 */
  .car-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; }
  .car-card { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow: hidden; transition: 0.2s; }
  .car-image-container { width: 100%; aspect-ratio: 4 / 3; background: #fdfdfd; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 5px; cursor: pointer; }
  .car-image-container img { width: 100%; height: 100%; object-fit: contain; }
  .car-info { padding: 8px; border-top: 1px solid #eee; }
  .car-id { font-size: 0.7rem; color: #cc0000; font-weight: bold; }
  .car-v-brand { font-size: 0.75rem; color: #666; margin: 2px 0; }
  .car-name { font-size: 0.85rem; font-weight: bold; margin: 0; line-height: 1.2; color: #333; }

  /* 2. 燈箱黑色背景：必須是全螢幕置中 */
  .lightbox {
    display: none; /* 由 JS 切換 */
    position: fixed;
    z-index: 10000;
    top: 0;
    left: 0;
    width: 100%;  /* 填滿寬度 */
    height: 100%; /* 填滿高度 */
    background-color: rgba(0,0,0,0.9);
    align-items: center;     /* 垂直置中 */
    justify-content: center;  /* 水平置中 */
    flex-direction: column;
    backdrop-filter: blur(5px); /* 背景模糊 */
  }

  /* 3. 燈箱內的圖片：這才是限制尺寸的地方 */
  .lightbox-content {
    max-width: 90vw;   /* 寬度最大 90% 視窗 */
    max-height: 80vh;  /* 高度最大 80% 視窗，留空間給文字 */
    object-fit: contain;
    box-shadow: 0 0 30px rgba(255,255,255,0.2); /* 讓圖片發光 */
    border: 2px solid rgba(255,255,255,0.5); /* 淡淡的細邊框 */
    border-radius: 4px;
    transition: transform 0.3s ease;
  }

  /* 4. 關閉按鈕與文字 */
  #caption {
    margin-top: 15px;
    color: #fff;
    font-weight: bold;
    font-size: 1.1rem;
    text-shadow: 2px 2px 4px #000;
  }

  .close-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    color: #fff;
    font-size: 50px;
    cursor: pointer;
    line-height: 1;
    transition: 0.2s;
  }
  .close-btn:hover { color: #cc0000; }

  /* --- 層級特效：金框與銀框 --- */
  
  /* 金框 (Rank 3) */
  .rank-gold {
    border: 2px solid #ffd700 !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); /* 稍微增強光暈 */
    position: relative;
    background: linear-gradient(145deg, #fffdf2, #fff);
  }

  /* 銀框 (Rank 2) - 已增強金屬感與亮度 */
  .rank-silver {
    border: 2px solid #C0C0C0 !important; /* 改用更亮的金屬銀 */
    box-shadow: 0 0 15px rgba(192, 192, 192, 0.7); /* 更強的銀色發光 */
    position: relative; /* 重要！一定要有這個，閃光才不會跑掉 */
    background: linear-gradient(145deg, #e6e6e6, #ffffff); /* 更明顯的金屬漸層 */
  }

  /* 閃光動畫通用設定 (金銀共用) */
  /* 這裡同時選取了 .rank-gold 和 .rank-silver 的 before 偽元素 */
  .rank-gold::before,
  .rank-silver::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    /* 閃光條：白色透明漸層 */
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.6), transparent);
    transform: rotate(45deg);
    animation: shine-effect 3s cubic-bezier(0.4, 0.0, 0.2, 1) infinite; /* 加快一點速度並調整曲線，更有質感 */
    pointer-events: none; /* 確保滑鼠還能點到下面的卡片 */
  }

  /* 閃光動畫關鍵影格 */
  @keyframes shine-effect {
    0% { left: -150%; top: -150%; opacity: 0; }
    30% { opacity: 1; }
    100% { left: 150%; top: 150%; opacity: 0; }
  }
</style>