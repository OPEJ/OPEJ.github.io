{{ define "main" }}
{{ partial "breadcrumbs.html" . }}
<div class="comparison-container">
    <h1>{{ .Title }}</h1>
    
    {{/* 方案 B：從 assets/data 讀取 CSV */}}
    {{ $csvResource := resources.Get "data/64_collection.csv" }}
    
    {{ if $csvResource }}
        {{ $data := $csvResource | transform.Unmarshal (dict "delimiter" ",") }}
        
        {{/* 讀取 Front Matter 的過濾設定 */}}
        {{ $fType := .Params.filter_type }}   {{/* 'brand' 或 'v_brand' */}}
        {{ $fValue := .Params.filter_value }} {{/* 例如 'Honda' */}}

        {{/* 建立品牌清單（如果沒有過濾值，就顯示全部品牌） */}}
        {{ $brands := slice }}
        {{ range after 1 $data }}
            {{ $val := "" }}
            {{ if eq $fType "brand" }} {{ $val = index . 1 }}
            {{ else if eq $fType "v_brand" }} {{ $val = index . 4 }}
            {{ else }} {{ $val = index . 1 }} {{ end }}

            {{ if or (not $fValue) (eq $val $fValue) }}
                {{ $brands = $brands | append (index . 1) }}
            {{ end }}
        {{ end }}
        {{ $brands = $brands | uniq | sort }}

        {{ range $brandName := $brands }}
            <div class="brand-group" style="margin-top: 40px;">
                <h2 class="brand-title" style="border-left: 5px solid #e74c3c; padding-left: 15px; background: #f8f9fa; padding-top: 10px; padding-bottom: 10px;">
                    {{ $brandName }} 
                    <span style="font-size: 1rem; color: #666; font-weight: normal;">
                        {{/* 這裡需要手動計算該品牌在過濾條件下的數量 */}}
                        {{ $count := 0 }}
                        {{ range after 1 $data }}
                            {{ $rowBrand := index . 1 }}
                            {{ $rowVBrand := index . 4 }}
                            {{ if eq $rowBrand $brandName }}
                                {{ if or (not $fValue) (eq (cond (eq $fType "v_brand") $rowVBrand $rowBrand) $fValue) }}
                                    {{ $count = add $count 1 }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                        ({{ $count }} 輛)
                    </span>
                </h2>
                
                <div class="comparison-grid">
                    {{ range after 1 $data }}
                        {{ $rowBrand := index . 1 }}
                        {{ $rowVBrand := index . 4 }}
                        
                        {{/* 判斷是否顯示：1.品牌正確 2.符合頁面過濾條件 */}}
                        {{ $matchFilter := or (not $fValue) (eq (cond (eq $fType "v_brand") $rowVBrand $rowBrand) $fValue) }}
                        
                        {{ if and (eq $rowBrand $brandName) $matchFilter }}
                            {{ $id := index . 2 }}
                            {{ $img := index . 3 }}
                            {{ $v_brand := index . 4 }}
                            {{ $type := index . 5 }}
                            {{ $name := index . 6 }}
                            {{ $box := index . 8 }}

                            <div class="model-card">
                                <div class="model-accent" style="background: #e74c3c; height: 4px;"></div>
                                <div class="model-image-container" style="background: #eee; height: 120px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    {{ if $img }}
                                        <img src="{{ printf "/images/164/%s" $img | relURL }}" loading="lazy" alt="{{ $name }}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                    {{ else }}
                                        <span style="color: #999; font-size: 0.8rem;">NO IMAGE</span>
                                    {{ end }}
                                </div>

                                <div class="model-info" style="padding: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.7rem; color: #e74c3c; font-weight: bold;">{{ $v_brand }}</span>
                                        <span style="font-size: 0.7rem; background: #ddd; padding: 2px 5px; border-radius: 3px;">{{ $id }}</span>
                                    </div>
                                    <h3 style="font-size: 0.9rem; margin: 5px 0; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2;">
                                        {{ $name }}
                                    </h3>
                                    <div style="font-size: 0.75rem; color: #666;">
                                        <span>{{ $type }}</span> | <span>{{ $box }}</span>
                                    </div>
                                </div>
                            </div>
                        {{ end }}
                    {{ end }}
                </div>
            </div>
        {{ end }}
    {{ else }}
        <p style="color: red; padding: 20px;">錯誤：找不到 CSV 檔案於 assets/data/64_collection.csv</p>
    {{ end }}
</div>

<style>
    .brand-title { margin-bottom: 20px; font-family: sans-serif; }
    .comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
    }
    .model-card {
        background: white;
        border: 1px solid #eee;
        border-radius: 4px;
        transition: 0.3s;
        overflow: hidden;
    }
    .model-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
</style>
{{ end }}